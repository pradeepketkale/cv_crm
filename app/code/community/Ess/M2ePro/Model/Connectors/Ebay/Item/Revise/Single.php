<?php/* * @copyright  Copyright (c) 2011 by  ESS-UA. */class Ess_M2ePro_Model_Connectors_Ebay_Item_Revise_Single extends Ess_M2ePro_Model_Connectors_Ebay_Item_SingleAbstract{    // ########################################    protected function getCommand()    {        return array('item','update','revise');    }    protected function getListingsLogsCurrentAction()    {        return Ess_M2ePro_Model_ListingsLogs::ACTION_RESIVE_PRODUCT_ON_EBAY;    }        // ########################################    protected function validateNeedRequestSend()    {        if (!$this->listingProduct->isRevisable()) {            $message = array(                // Parser hack -> Mage::helper('M2ePro')->__('Item is not listed or not available');                parent::MESSAGE_TEXT_KEY => 'Item is not listed or not available',                parent::MESSAGE_TYPE_KEY => parent::MESSAGE_TYPE_ERROR            );            $this->addListingsProductsLogsMessage($this->listingProduct,$message,                                                  Ess_M2ePro_Model_ListingsLogs::PRIORITY_MEDIUM);            return false;        }        if (Mage::helper('M2ePro/Variations')->isAddedNewVariationsAttributes($this->listingProduct)) {            $message = array(                // Parser hack -> Mage::helper('M2ePro')->__('New variation attribute added. Please stop and relist product.');                parent::MESSAGE_TEXT_KEY => 'New variation attribute added. Please stop and relist product.',                parent::MESSAGE_TYPE_KEY => parent::MESSAGE_TYPE_ERROR            );            $this->addListingsProductsLogsMessage($this->listingProduct,$message,                                                  Ess_M2ePro_Model_ListingsLogs::PRIORITY_HIGH);            return false;        }        return true;    }        protected function getRequestData()    {        $requestData = Mage::getModel('M2ePro/Connectors_Ebay_Item_Helper')                                ->getReviseRequestData($this->listingProduct,$this->params);        return $requestData;    }    //----------------------------------------    protected function validateResponseData($response)    {        return true;    }    protected function prepareResponseData($response)    {        if (isset($response['already_stop'])) {            $tempParams = array(                'status_changer' => Ess_M2ePro_Model_ListingsProducts::STATUS_CHANGER_EBAY            );            if (isset($response['ebay_end_date_raw'])) {                $tempParams['ebay_end_date_raw'] = $response['ebay_end_date_raw'];            }            Mage::getModel('M2ePro/Connectors_Ebay_Item_Helper')                        ->updateAfterStopAction($this->listingProduct,                                                array_merge($this->params,$tempParams));        } else if (isset($response['result'])) {            Mage::getModel('M2ePro/Connectors_Ebay_Item_Helper')                                ->updateAfterReviseAction($this->listingProduct,                                                          array_merge($this->params,$response['result']));            $message = array(                // Parser hack -> Mage::helper('M2ePro')->__('Item was successfully revised');                parent::MESSAGE_TEXT_KEY => 'Item was successfully revised',                parent::MESSAGE_TYPE_KEY => parent::MESSAGE_TYPE_SUCCESS            );            $this->addListingsProductsLogsMessage($this->listingProduct, $message,                                                  Ess_M2ePro_Model_ListingsLogs::PRIORITY_MEDIUM);        }        return $response;    }    // ########################################}
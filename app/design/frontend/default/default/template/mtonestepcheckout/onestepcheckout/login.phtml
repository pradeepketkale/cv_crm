<?php
/******************************************************
 * @package MT OneStepCheckOut module for Magento 1.4.x.x and Magento 1.5.x.x
 * @version 1.5.2.1
 * @author http://www.magentheme.com
 * @copyright (C) 2011- MagenTheme.Com
 * @license PHP files are GNU/GPL
*******************************************************/
?>
<?php
$hlp = Mage::helper('generalcheck');
$ismobile = $hlp->ismobile();

if(!$ismobile)
{?>  
<div class="onestepcheckout-checkout-method">
    <?php //echo $this->getChildHtml('login_before')?>
    <?php //if( $this->getQuote()->isAllowedGuestCheckout() ): ?>
    <!--a href="javascript:void(0);" onclick="login.show();"><?php //echo $this->__('Already registered? Please log in below.') ?></a-->
    <?php //endif; ?>
	


	<?php /*
		----------------------------------------------------------------------------------------
		mchechout code starts
		----------------------------------------------------------------------------------------
	*/?>

<div class="loginstep">
<div>
	<ul class="form paddingtop">
	  <li class="user_status">
		<div class="floatl forgotpassword">
		  <input type="radio" name="user_pass" id="existinguser" checked="checked" onclick="swaphtml(this, 'old')"/>
		  <span class="bold">I am an existing customer</span> </div>
		<div class="floatr paddingright">
		  <input type="radio" name="user_pass" id="reset" onclick="swaphtml(this, 'new')"/>
		  <span class="bold">I am a new customer</span>
		  <p class="paddleft">(You can continue shopping as guest and register your self)</p>
		</div>
	  </li>
	</ul>
	<span class="clr"></span>

	<!--Log in for Existing User-->
	<div class="existinguser emailid_field" > 
	   <div id="ajaxloginform">
		<ul class="form">
		  <li><label>Email ID:<span class="req">*</span></label><input class="input-text required email validate-email1 required-entry" type="text" name="login[username]" id="email" /></li>
		  <li><label>Password:<span class="req">*</span></label><input class="input-text required required-entry" type="password" name="login[password]" id="password" /></li>                            
		  <li>
          <label></label>
			<div class="btn icon-btn_138 red fancybox em modal_link" id="login-submit"><span class="inner">Login</span></div>
			<div class="ajaxloadermtosc displaynone"></div>
			<a id="forgot_pass" href="#login_popup" class="fancybox">Forgot Password?</a>
		  </li>
		</ul></div>
	</div>
		 <!--Log in for Existing User END-->

  <span class="clr"></span>
  <input type="hidden" name="checkout_method" id="login:register" value="register" checked="checked" />
</div>

<div id="login_popup" class="displaynone">
	<div class="contentrow">
		<p class="bigtitle">Forgotten your password?</p>
		<p>Enter your email below and we'll send you a new password by email.</p>
		<div id="onestepcheckout-forgot-form">                                                                      
	   <div class="forgotpass">
		<label for="id_onestepcheckout_email">Email address</label>
		<input type="text" id="id_onestepcheckout_email" name="onestepcheckout_email" class="input_forgot input-text required email validate-email1 required-entry">
		<button type="button" id="onestepcheckout-forgot-button" class="btnsmallgrey send_password">Send password</button>
	   </div>
		</div>
	</div>	
		<p style="margin-top: 20px;"><a onclick="returnto()" id="onestepcheckout-return-login-link" href="javascript:void(0);" rel="">Return to login</a></p>
		
</div>
</div>



<script type="text/javascript">
	jQuery(document).ready(new function(){
		jQuery('#forgot_pass').fancybox({
			/*'titleShow' : false,
			'transitionIn' : 'elastic',
			'transitionOut' : 'elastic',
			'easingIn' : 'easeOutBack',
			'easingOut' : 'easeInBack'  */
			//'titlePosition' : 'inside',
			//'transitionIn' : 'none',
			//'transitionOut' : 'none' 
			'modal' : true,
			'showCloseButton':true
		});

		<?php if($this->isCustomerLoggedIn()): ?>
			jQuery("#billingdetails").show();
			jQuery("#billingdetails #billship2").show();
			jQuery("#logindeatils").hide();
		<?php else:?>
		<?php endif;?>



		
		
		jQuery('#existinguser').attr('checked', true);
		jQuery('.send_password').live('click', function(){
			ajaxsendpassword();return false;
		});
		jQuery('#login_popup').keypress(function(e) {
			if(e.which == 13) {
				ajaxsendpassword();return false;
			}
		});
		
		
		//Javascript function to send autogenerated password in case customer has forgotten the password
		
		function ajaxsendpassword(){
			//var result = jQuery('#onestepcheckout-forgot-form').valid();
			//if(result){
			var validator = new Validation('onestepcheckout-forgot-form');
			if(validator.validate()) {
				var email = jQuery('.input_forgot').val();
				// jQuery.post("<?php echo $this->getUrl('mcheckout/onepage/forgotPasswordPostAjax')?>", { email: email}, function(data){
				 jQuery.post("<?php echo $this->getUrl('mtonestepcheckout/index/forgotPasswordPostAjax')?>", { email: email}, function(data){
					 if(data == 'success'){
						var displayhtml = '<div class="displaymsg">If there is an account associated with '+email+' you will receive an email with your autogenerated password.</div>'
						//jQuery('.send_password').after(displayhtml);
						jQuery('.fancybox-inner .contentrow').html(displayhtml);
						jQuery('#onestepcheckout-return-login-link').attr('rel', email);
					 } else{
						alert(data);
					 }
				   });
			}
		}
		
		jQuery('#login-submit').bind('click', function(){
			
			/*
			var result = jQuery('#ajaxloginform').valid();
			if(result){
				jQuery('#ajaxloginform').submit();
			}
			*/
			ajaxlogin();return false;
		});
		
		jQuery('#ajaxloginform').keypress(function(e) {
			if(e.which == 13) {
				/*
				var result = jQuery('#ajaxloginform').valid();
				if(result){
					jQuery('#ajaxloginform').submit();
				}
				*/
				ajaxlogin();return false;
			}
		});
		
		
		// Javascript function to make logic action ajax
		
		function ajaxlogin(){
			//var logindata = decodeURIComponent(jQuery('#ajaxloginform').serialize());
			var validator = new Validation('ajaxloginform');
			if(validator.validate()) {
				jQuery('.ajaxloadermtosc').show();
				jQuery('#login-submit').hide();
				var email = jQuery('#ajaxloginform #email').val();
				var pass = jQuery('#ajaxloginform #password').val();
				// jQuery.post("<?php echo $this->getUrl('mcheckout/onepage/ajaxloginpost')?>", {username: email, password: pass}, function(data){
				 jQuery.post("<?php echo $this->getUrl('mtonestepcheckout/index/ajaxloginpost')?>", {username: email, password: pass}, function(data){
						if(data == 'success'){
							document.location.reload(true);return false;
							//jQuery("#billingdetails").show();
							//jQuery("#billingdetails #billship2").show();
							//jQuery("#logindeatils").hide();
							//alert('Login Success');return false;
						} else{
							jQuery('#login-submit').show();
							jQuery('.ajaxloadermtosc').hide();
							alert(data);return false;
						}
				   });
			}
		
		}
		
		
	});
		function swaphtml(x, user){
			if(user == 'old'){
				$j('.existinguser ').show();
				$j('#tab-1 .tab1inner').hide();
				
			} else if(user == 'new'){
				$j('.existinguser ').hide();
				$j('#tab-1 .tab1inner').show();
			}
		}
	
	function returnto(){
		jQuery.fancybox.close();
		var email =	jQuery('#onestepcheckout-return-login-link').attr('rel');
		jQuery('.existinguser #email').val(email);
	}
</script>
	<?php /*
		----------------------------------------------------------------------------------------
		mchechout code ends
		----------------------------------------------------------------------------------------
	*/?>
	
</div>
<script type="text/javascript">
//<![CDATA[
    var login = new Login('<?php echo $this->getUrl('mtonestepcheckout/index/loginPost') ?>','600','300');
    var loginForm = new VarienForm('login-form', true);
//]]>

</script>





<?php }else{?>
<div class="onestepcheckout-checkout-method">
    <?php //echo $this->getChildHtml('login_before')?>
    <?php //if( $this->getQuote()->isAllowedGuestCheckout() ): ?>
    <!--a href="javascript:void(0);" onclick="login.show();"><?php //echo $this->__('Already registered? Please log in below.') ?></a-->
    <?php //endif; ?>
	


	<?php /*
		----------------------------------------------------------------------------------------
		mchechout code starts
		----------------------------------------------------------------------------------------
	*/?>

<div class="loginstep" >
<div>
	<ul class="form paddingtop" style="width:100%;">
	  <li class="user_status">
		<div class="floatl forgotpassword">
		  <input type="radio" name="user_pass" id="existinguser"  onclick="swaphtml(this, 'old')"/>
		  <span class="bold" style="font-size:1.3em;">I am an existing customer</span> </div>
<br>
		<div class="floatr paddingright" style="float:none;padding-top:3%; margin-left:37px;">
		  <input type="radio" name="user_pass" id="reset"  onclick="swaphtml(this, 'new')" checked="checked"/>
		  <span class="bold" style="font-size:1.3em;">I am a new customer</span>
		  <p class="paddleft">(You can continue shopping as guest and register your self)</p>
		</div>
	  </li>
	</ul>
	<span class="clr"></span>

	<!--Log in for Existing User-->
	<div class="existinguser emailid_field" style="width:96%;display:none;"> 
	   <div id="ajaxloginform" style="fontsize:134%;width:98%;">
		<ul class="form"   >
		  <li  ><label style="width: 22%;"><font size="+3">Email ID:</font><span class="req">*</span></label><input class="input-text required email validate-email1 required-entry" style="color:black;height:68px;width: 76%!important;font-size: 38px;" type="text"  name="login[username]" id="email" /></li>
		  <li style="fontsize:1.4em;" ><label style="width: 22%;"><font size="+3">Password:</font><span class="req">*</span></label><input class="input-text required required-entry" style="color:black;height:68px;width: 76%!important;font-size: 38px;" type="password" name="login[password]" id="password" /></li>                            
		  <li>
          <label></label>
			<div class="btn icon-btn_138 red fancybox em modal_link" id="login-submit" style="width:100%;"><span class="newaddcartbutton12092014" style="width:98%;height:45px;line-height:52px;font-size:35px;">Login</span></div>
			<div class="ajaxloadermtosc displaynone"></div>
<br>	<br>		<a id="forgot_pass" href="#login_popup" style="font-size:1.3em;margin-left:29%;" class="fancybox">Forgot Password?</a>
		  </li>
		</ul></div>
	</div>
		 <!--Log in for Existing User END-->

  <span class="clr"></span>
  <input type="hidden" name="checkout_method" id="login:register" value="register" checked="checked" />
</div>

<div id="login_popup" class="displaynone">
	<div class="contentrow">
		<p class="bigtitle">Forgotten your password?</p>
		<p>Enter your email below and we'll send you a new password by email.</p>
		<div id="onestepcheckout-forgot-form">                                                                      
	   <div class="forgotpass">
		<label for="id_onestepcheckout_email">Email address</label>
		<input type="text" id="id_onestepcheckout_email" name="onestepcheckout_email" class="input_forgot input-text required email validate-email1 required-entry">
		<button type="button" id="onestepcheckout-forgot-button" class="btnsmallgrey send_password">Send password</button>
	   </div>
		</div>
	</div>	
		<p style="margin-top: 20px;"><a onclick="returnto()" id="onestepcheckout-return-login-link" href="javascript:void(0);" rel="">Return to login</a></p>
		
</div>
</div>



<script type="text/javascript">
	jQuery(document).ready(new function(){
		jQuery('#forgot_pass').fancybox({
			/*'titleShow' : false,
			'transitionIn' : 'elastic',
			'transitionOut' : 'elastic',
			'easingIn' : 'easeOutBack',
			'easingOut' : 'easeInBack'  */
			//'titlePosition' : 'inside',
			//'transitionIn' : 'none',
			//'transitionOut' : 'none' 
			'modal' : true,
			'showCloseButton':true
		});

		<?php if($this->isCustomerLoggedIn()): ?>
			jQuery("#billingdetails").show();
			jQuery("#billingdetails #billship2").show();
			jQuery("#logindeatils").hide();
		<?php else:?>
		<?php endif;?>



		
		
		jQuery('#reset').attr('checked', true);
		jQuery('.send_password').live('click', function(){
			ajaxsendpassword();return false;
		});
		jQuery('#login_popup').keypress(function(e) {
			if(e.which == 13) {
				ajaxsendpassword();return false;
			}
		});


		
		
		//Javascript function to send autogenerated password in case customer has forgotten the password
		
		function ajaxsendpassword(){
			//var result = jQuery('#onestepcheckout-forgot-form').valid();
			//if(result){
			var validator = new Validation('onestepcheckout-forgot-form');
			if(validator.validate()) {
				var email = jQuery('.input_forgot').val();
				// jQuery.post("<?php echo $this->getUrl('mcheckout/onepage/forgotPasswordPostAjax')?>", { email: email}, function(data){
				 jQuery.post("<?php echo $this->getUrl('mtonestepcheckout/index/forgotPasswordPostAjax')?>", { email: email}, function(data){
					 if(data == 'success'){
						var displayhtml = '<div class="displaymsg">If there is an account associated with '+email+' you will receive an email with your autogenerated password.</div>'
						//jQuery('.send_password').after(displayhtml);
						jQuery('.fancybox-inner .contentrow').html(displayhtml);
						jQuery('#onestepcheckout-return-login-link').attr('rel', email);
					 } else{
						alert(data);
					 }
				   });
			}
		}
		
		jQuery('#login-submit').bind('click', function(){
			
			/*
			var result = jQuery('#ajaxloginform').valid();
			if(result){
				jQuery('#ajaxloginform').submit();
			}
			*/
			ajaxlogin();return false;
		});
		
		jQuery('#ajaxloginform').keypress(function(e) {
			if(e.which == 13) {
				/*
				var result = jQuery('#ajaxloginform').valid();
				if(result){
					jQuery('#ajaxloginform').submit();
				}
				*/
				ajaxlogin();return false;
			}
		});
		
		
		// Javascript function to make logic action ajax
		
		function ajaxlogin(){
			//var logindata = decodeURIComponent(jQuery('#ajaxloginform').serialize());
			var validator = new Validation('ajaxloginform');
			if(validator.validate()) {
				jQuery('.ajaxloadermtosc').show();
				jQuery('#login-submit').hide();
				var email = jQuery('#ajaxloginform #email').val();
				var pass = jQuery('#ajaxloginform #password').val();
				// jQuery.post("<?php echo $this->getUrl('mcheckout/onepage/ajaxloginpost')?>", {username: email, password: pass}, function(data){
				 jQuery.post("<?php echo $this->getUrl('mtonestepcheckout/index/ajaxloginpost')?>", {username: email, password: pass}, function(data){
						if(data == 'success'){
							document.location.reload(true);return false;
							//jQuery("#billingdetails").show();
							//jQuery("#billingdetails #billship2").show();
							//jQuery("#logindeatils").hide();
							//alert('Login Success');return false;
						} else{
							jQuery('#login-submit').show();
							jQuery('.ajaxloadermtosc').hide();
							alert(data);return false;
						}
				   });
			}
		
		}
		
		
	});
		function swaphtml(x, user){
			if(user == 'old'){
				$j('.existinguser ').show();
				$j('#tab-1 .tab1inner').hide();
				
			} else if(user == 'new'){
				$j('.existinguser ').hide();
				$j('#tab-1 .tab1inner').show();
			}
		}
	
	function returnto(){
		jQuery.fancybox.close();
		var email =	jQuery('#onestepcheckout-return-login-link').attr('rel');
		jQuery('.existinguser #email').val(email);
	}
</script>
	<?php /*
		----------------------------------------------------------------------------------------
		mchechout code ends
		----------------------------------------------------------------------------------------
	*/?>
	
</div>
<script type="text/javascript">
//<![CDATA[
    var login = new Login('<?php echo $this->getUrl('mtonestepcheckout/index/loginPost') ?>','600','300');
    var loginForm = new VarienForm('login-form', true);
//]]>

</script>
<?php } ?>
